{"_id":"9zP2VE60ZvDsKl9V","name":"New Macro","permission":{"default":0,"nxWKrSSCtrgMV99N":3},"type":"script","sort":100001,"flags":{},"scope":"global","command":"/**\r\n * Quick'n'dirty GUI for moving (as in copy) entities en-masse to compendiums.\r\n * Dependency on Plutonium for various library code/CSS.\r\n */\r\n(() => {\r\n\tclass BulkMover extends Application {\r\n\t\tstatic getMaxWindowHeight (desiredHeight) {\r\n\t\t\tconst targetHeight = Math.min(desiredHeight || Number.MAX_SAFE_INTEGER, document.documentElement.clientHeight - 150);\r\n\t\t\treturn Math.max(150, targetHeight);\r\n\t\t}\r\n\r\n\t\tstatic showProgressBar () {\r\n\t\t\tconst $dispProgress = $(`<div style=\"height: 20px; background: darkred;\"></div>`);\r\n\t\t\tconst $btnCancelClose = $(`<button class=\"btn btn-5et btn-xs\"><i class=\"fas fa-times\"></i></button>`)\r\n\t\t\t\t.click(() => {\r\n\t\t\t\t\tout.isCancelled = true;\r\n\t\t\t\t\tdoCleanup();\r\n\t\t\t\t});\r\n\r\n\t\t\tconst $bar = $$`<div class=\"flex-v-center\" style=\"position: fixed; bottom: 90px; left: 0; right: 305px; height: 20px; background: #8888; z-index: 1000000; width: calc(100vw - 305px);\">\r\n\t\t\t\t<div class=\"w-100 mr-2\">${$dispProgress}</div>\r\n\t\t\t\t${$btnCancelClose}\r\n\t\t\t</div>`.appendTo(document.body);\r\n\r\n\t\t\tconst doCleanup = () => {\r\n\t\t\t\t$bar.remove();\r\n\t\t\t};\r\n\r\n\t\t\tconst out = {\r\n\t\t\t\tsetProgress: (count, total) => {\r\n\t\t\t\t\tconst pct = count / total || 1;\r\n\t\t\t\t\t$dispProgress.css(\"width\", `${Math.round(pct * 100)}%`);\r\n\t\t\t\t},\r\n\t\t\t\tisCancelled: false,\r\n\t\t\t\tdoCleanup\r\n\t\t\t};\r\n\t\t\treturn out;\r\n\t\t}\r\n\r\n\t\tconstructor () {\r\n\t\t\tsuper({\r\n\t\t\t\twidth: 800,\r\n\t\t\t\theight: BulkMover.getMaxWindowHeight(),\r\n\t\t\t\ttitle: \"Bulk Move to Compendium\",\r\n\t\t\t\ttemplate: `modules/plutonium/template/ImportList.handlebars`,\r\n\t\t\t\tresizable: true\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tactivateListeners ($html) {\r\n\t\t\t$html.empty().addClass(\"flex-col h-100 ve-window min-h-0\");\r\n\r\n\t\t\tconst DIR_METAS = [\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"Scenes\",\r\n\t\t\t\t\tfolderType: \"Scene\",\r\n\t\t\t\t\tcollection: Scene.collection\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"Actors\",\r\n\t\t\t\t\tfolderType: \"Actor\",\r\n\t\t\t\t\tcollection: Actor.collection\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"Items\",\r\n\t\t\t\t\tfolderType: \"Item\",\r\n\t\t\t\t\tcollection: Item.collection\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"Journal Entries\",\r\n\t\t\t\t\tfolderType: \"JournalEntry\",\r\n\t\t\t\t\tcollection: JournalEntry.collection\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tname: \"Rollable Tables\",\r\n\t\t\t\t\tfolderType: \"RollTable\",\r\n\t\t\t\t\tcollection: RollTable.collection\r\n\t\t\t\t}\r\n\t\t\t];\r\n\r\n\t\t\tconst tabMetas = DIR_METAS.map((meta, i) => {\r\n\t\t\t\tlet rowMetas = [];\r\n\r\n\t\t\t\tconst $wrpList = $(`<div class=\"w-100 h-100 overflow-y-auto flex-col min-h-0\"></div>`);\r\n\r\n\t\t\t\tconst doPopulate = () => {\r\n\t\t\t\t\t$wrpList.empty();\r\n\r\n\t\t\t\t\tmeta.collection.entities.forEach(ent => {\r\n\t\t\t\t\t\tconst $cb = $(`<input type=\"checkbox\">`);\r\n\r\n\t\t\t\t\t\tconst $row = $$`<label class=\"row w-100\">\r\n\t\t\t\t\t\t\t<div class=\"col-2 flex-vh-center\">${$cb}</div>\r\n\t\t\t\t\t\t\t<div class=\"col-10 flex-v-center\">${ent.name}</div>\r\n\t\t\t\t\t\t</label>`.appendTo($wrpList);\r\n\r\n\t\t\t\t\t\trowMetas.push({\r\n\t\t\t\t\t\t\tentityName: ent.name,\r\n\t\t\t\t\t\t\tentityId: ent.id,\r\n\t\t\t\t\t\t\t$cb,\r\n\t\t\t\t\t\t\t$row,\r\n\t\t\t\t\t\t\tsearchKey: ent.name.toLowerCase().trim(),\r\n\t\t\t\t\t\t\tisVisible: true\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\t$iptSearch.change();\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst $cbAll = $(`<input type=\"checkbox\">`)\r\n\t\t\t\t\t.change(() => {\r\n\t\t\t\t\t\tconst val = $cbAll.prop(\"checked\");\r\n\t\t\t\t\t\trowMetas.filter(it => it.isVisible).forEach(it => it.$cb.prop(\"checked\", val));\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\tconst $iptSearch = $(`<input class=\"mr-2 form-control w-100\" type=\"text\" placeholder=\"Search ${meta.name.toLowerCase()}...\">`)\r\n\t\t\t\t\t.change(() => {\r\n\t\t\t\t\t\tconst searchTerm = $iptSearch.val().trim().toLowerCase();\r\n\t\t\t\t\t\trowMetas.forEach(it => {\r\n\t\t\t\t\t\t\tconst isVisible = it.searchKey.includes(searchTerm);\r\n\t\t\t\t\t\t\tit.isVisible = isVisible;\r\n\t\t\t\t\t\t\tit.$row.toggleVe(isVisible);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\tconst $btnRefresh = $(`<button class=\"btn btn-xs btn-5et\" title=\"Refresh List\"><i class=\"fas fa-sync\"></i></button>`)\r\n\t\t\t\t\t.click(() => doPopulate());\r\n\r\n\t\t\t\tconst $tab = $$`<div class=\"flex-col w-100 h-100\">\r\n\t\t\t\t\t<div class=\"w-100 mb-2 row flex-vh-center\">\r\n\t\t\t\t\t\t<label class=\"flex-vh-center col-2\">${$cbAll}</label>\r\n\t\t\t\t\t\t<div class=\"flex-v-center col-10\">${$iptSearch}${$btnRefresh}</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t${$wrpList}\r\n\t\t\t\t<div/>`;\r\n\r\n\t\t\t\t// region Footer\r\n\t\t\t\tconst $selCompendium = $(`<select class=\"form-control mr-1\"></select>`);\r\n\t\t\t\tconst doPopulateSelCompendium = () => {\r\n\t\t\t\t\t$selCompendium.empty();\r\n\r\n\t\t\t\t\tconst availPacks = game.packs.filter(it => !it.locked && it.metadata.entity === meta.folderType);\r\n\t\t\t\t\tavailPacks.forEach(p => $selCompendium.append(`<option value=\"${p.collection}\">${p.metadata.label}</option>`));\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst $btnRepopulateSelCompendium = $(`<button class=\"btn btn-5et btn-xs\" title=\"Refresh Compendium List\"><i class=\"fas fa-sync\"></i></button>`)\r\n\t\t\t\t\t.click(() => doPopulateSelCompendium())\r\n\r\n\t\t\t\tconst $btnRun = $(`<button class=\"btn btn-default btn-5et w-100\">Run</button>`)\r\n\t\t\t\t\t.click(async () => {\r\n\t\t\t\t\t\tconst compendiumId = $selCompendium.val();\r\n\t\t\t\t\t\tif (!compendiumId) return ui.notifications.error(`Please select a compendium!`);\r\n\r\n\t\t\t\t\t\tconst pack = game.packs.find(p => p.collection === compendiumId);\r\n\t\t\t\t\t\tif (!pack) return ui.notifications.error(`Could not find compendium \"${compendiumId}\"`);\r\n\r\n\t\t\t\t\t\tconst selRowMetas = rowMetas.filter(it => it.$cb.prop(\"checked\"));\r\n\r\n\t\t\t\t\t\tconst packIndex = await pack.getIndex();\r\n\t\t\t\t\t\tconst isOverwrite = $cbOverwriteExisting.prop(\"checked\");\r\n\r\n\t\t\t\t\t\tconst progressBar = BulkMover.showProgressBar();\r\n\r\n\t\t\t\t\t\tlet cntSuccess = 0;\r\n\t\t\t\t\t\tlet cntError = 0;\r\n\t\t\t\t\t\tlet cntOverwrites = 0;\r\n\t\t\t\t\t\tfor (const selRowMeta of selRowMetas) {\r\n\t\t\t\t\t\t\tif (progressBar.isCancelled) break;\r\n\t\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\t\tconst entity = meta.collection.get(selRowMeta.entityId);\r\n\r\n\t\t\t\t\t\t\t\tconst entry = packIndex.find(e => e.name === entity.name);\r\n\t\t\t\t\t\t\t\tif (entry != null && isOverwrite) {\r\n\t\t\t\t\t\t\t\t\tcntOverwrites++;\r\n\t\t\t\t\t\t\t\t\tif (progressBar.isCancelled) break;\r\n\t\t\t\t\t\t\t\t\tawait pack.deleteEntity(entry._id);\r\n\t\t\t\t\t\t\t\t\tif (progressBar.isCancelled) break;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (progressBar.isCancelled) break;\r\n\t\t\t\t\t\t\t\tawait pack.importEntity(entity);\r\n\r\n\t\t\t\t\t\t\t\tcntSuccess++;\r\n\t\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\t\tcntError++\r\n\t\t\t\t\t\t\t\tui.notifications.error(`Failed to transfer ${selRowMeta.entityName} (id ${selRowMeta.entityId})! ${VeCt.STR_SEE_CONSOLE}`);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tprogressBar.setProgress(cntSuccess + cntError, selRowMetas.length);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tprogressBar.doCleanup();\r\n\t\t\t\t\t\tui.notifications.info(`Run complete. ${cntSuccess} entit${cntSuccess === 1 ? \"y\" : \"ies\"} moved successfully (${cntOverwrites} overwrite${cntOverwrites === 1 ? \"\" : \"s\"}); ${cntError} error${cntError === 1 ? \"\" : \"s\"}.`);\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\tconst $cbOverwriteExisting = $(`<input type=\"checkbox\" checked>`)\r\n\r\n\t\t\t\tconst $tabFooter = $$`<div class=\"w-100 no-shrink flex-v-center\">\r\n\t\t\t\t\t<div class=\"mr-2 flex-col no-shrink\">\r\n\t\t\t\t\t\t<div class=\"w-100 mb-2\">Select Compendium</div>\r\n\t\t\t\t\t\t<div class=\"w-100 flex-vh-center\">${$selCompendium}${$btnRepopulateSelCompendium}</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div class=\"flex-col mr-2 no-shrink\">\r\n\t\t\t\t\t\t<label class=\"flex w-100\"><div class=\"mr-2\">Overwrite Existing</div>${$cbOverwriteExisting}</label>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div class=\"flex-vh-center w-100 mr-3\">\r\n\t\t\t\t\t\t${$btnRun}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>`;\r\n\t\t\t\t// endregion\r\n\r\n\t\t\t\tconst out = {\r\n\t\t\t\t\t$tab,\r\n\t\t\t\t\t$tabFooter,\r\n\t\t\t\t\tisActive: i === 0,\r\n\t\t\t\t\tactivate: () => {\r\n\t\t\t\t\t\tout.isActive = true;\r\n\t\t\t\t\t\tout.$tab.showVe();\r\n\t\t\t\t\t\tout.$tabFooter.showVe();\r\n\t\t\t\t\t\tdoPopulate();\r\n\t\t\t\t\t\tdoPopulateSelCompendium();\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\treturn out;\r\n\t\t\t});\r\n\r\n\t\t\tconst $btnsTabHeaders = DIR_METAS.map((meta, i) => {\r\n\t\t\t\treturn $(`<button class=\"btn btn-5et btn-default w-100\">${meta.name}</button>`)\r\n\t\t\t\t\t.click(() => {\r\n\t\t\t\t\t\t$btnsTabHeaders.forEach(($btn, j) => $btn.toggleClass(\"active\", i === j));\r\n\r\n\t\t\t\t\t\ttabMetas.forEach(meta => {\r\n\t\t\t\t\t\t\tmeta.isActive = false;\r\n\t\t\t\t\t\t\tmeta.$tab.hideVe();\r\n\t\t\t\t\t\t\tmeta.$tabFooter.hideVe();\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tconst activeMeta = tabMetas[i];\r\n\t\t\t\t\t\tactiveMeta.activate();\r\n\t\t\t\t\t})\r\n\t\t\t});\r\n\r\n\t\t\t$$($html)`<div class=\"w-100 h-100 flex-col\">\r\n\t\t\t\t<div class=\"flex btn-group w-100 mb-2\">${$btnsTabHeaders}</div>\r\n\t\t\t\t<div class=\"flex w-100 h-100 min-h-0\">\r\n\t\t\t\t\t${tabMetas.map(meta => meta.$tab)}\r\n\t\t\t\t</div>\r\n\t\t\t\t${tabMetas.map(meta => meta.$tabFooter)}\r\n\t\t\t</div>`;\r\n\r\n\t\t\t$btnsTabHeaders[0].click();\r\n\t\t}\r\n\t}\r\n\t(new BulkMover()).render(true);\r\n})();\r\n","author":"nxWKrSSCtrgMV99N","img":"icons/svg/dice-target.svg","actorIds":[]}
{"_id":"N2NlMzFkOTNjNzE3","name":"North-of-Waterdeep-Days8-10","permission":{"default":0,"YTc0OWY0YmZjNTBi":3},"type":"chat","sort":40000,"flags":{},"scope":"global","command":"/w gm &{template:npcaction} {{rname= Random Encounters}}{{name= North of Waterdeep, Days 8-10 }} {{description= [[ 1t[Encounters-North-of-Waterdeep-Days8-10] ]] }} \n/w gm &{template:npcaction} {{rname= NPC Losses Elsewhere }} {{name= North of Waterdeep, Days 8-10 }} {{description= [[ 1d4-2 ]] NPC escort(s) were killed elsewhere in battle if an encounter occured. }}","author":"YTc0OWY0YmZjNTBi","img":"worlds/hoard-of-the-dragon-queen/macros/roll20_macro.png","actorIds":[]}
{"_id":"OTVlNjhiZGYxOGFi","name":"Ep3-Random-Encounters","permission":{"default":0,"YTc0OWY0YmZjNTBi":3},"type":"chat","sort":10000,"flags":{},"scope":"global","command":"/w gm &{template:npcaction} {{rname= Random Encounters}}{{name= Episode 3 }} {{description= Encounters here occur on a roll of 1. [[ 1d6 ]] }} \n/w gm &{template:npcaction} {{rname= Random Encounter Table }} {{name= Episode 3 }} {{description= [[ 1t[Ep3-Encounters] ]] }}","author":"YTc0OWY0YmZjNTBi","img":"worlds/hoard-of-the-dragon-queen/macros/roll20_macro.png","actorIds":[]}
{"_id":"YTk5NTBlMDdhNGRk","name":"Trade-Way-Events","permission":{"default":0,"YTc0OWY0YmZjNTBi":3},"type":"chat","sort":20000,"flags":{},"scope":"global","command":"/w gm &{template:npcaction} {{rname= Random Encounters}}{{name= Trade Way Events }} {{description= [[ 1t[Trade-Way-Encounters] ]] today. }} \n/w gm &{template:npcaction} {{rname= Random Encounter Table }} {{name= Trade Way Events }} {{description= [[ 1t[Trade-Way-Events] ]] }}","author":"YTc0OWY0YmZjNTBi","img":"worlds/hoard-of-the-dragon-queen/macros/roll20_macro.png","actorIds":[]}
{"_id":"YjlmMTI1M2Y5YWI1","name":"Ep1-Random-Encounters","permission":{"default":0,"YTc0OWY0YmZjNTBi":3},"type":"chat","sort":0,"flags":{},"scope":"global","command":"/w gm &{template:npcaction} {{rname= Random Encounters}}{{name= Episode 1 }} {{description= Encounters here occur on a roll of 5 or higher. [[ 1d8 ]] }} \n/w gm &{template:npcaction} {{rname= Random Encounter Table }} {{name= Episode 1 }} {{description= [[ 1t[Ep1-Encounters] ]] }}","author":"YTc0OWY0YmZjNTBi","img":"worlds/hoard-of-the-dragon-queen/macros/roll20_macro.png","actorIds":[]}
{"_id":"ZDY1NDY3YmI5YTdl","name":"Mere-of-Dead-Men-Encounters","permission":{"default":0,"YTc0OWY0YmZjNTBi":3},"type":"chat","sort":50000,"flags":{},"scope":"global","command":"/w gm &{template:npcaction} {{rname= Random Encounters}}{{name= Mere of Dead Men }} {{description= Encounters here occur on a roll of 18-20. [[ 1d20 ]] }} \n/w gm &{template:npcaction} {{rname= Random Encounter Table }} {{name= Mere of Dead Men }} {{description= [[ 1t[Mere-of-Dead-Men-Encounters] ]] }}","author":"YTc0OWY0YmZjNTBi","img":"worlds/hoard-of-the-dragon-queen/macros/roll20_macro.png","actorIds":[]}
{"_id":"ZWMyZmQ2YTY4MjEw","name":"North-of-Waterdeep-Days1-7","permission":{"default":0,"YTc0OWY0YmZjNTBi":3},"type":"chat","sort":30000,"flags":{},"scope":"global","command":"/w gm &{template:npcaction} {{rname= Random Encounters}}{{name= North of Waterdeep, Days 1-7 }} {{description= [[ 1t[Encounters-North-of-Waterdeep-Days1-7] ]] }} \n/w gm &{template:npcaction} {{rname= NPC Losses Elsewhere }} {{name= North of Waterdeep, Days 1-7 }} {{description= [[ 1d4-2 ]] NPC escort(s) were killed elsewhere in battle if an encounter occured. }}","author":"YTc0OWY0YmZjNTBi","img":"worlds/hoard-of-the-dragon-queen/macros/roll20_macro.png","actorIds":[]}
